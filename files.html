<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TIᗡƎ-YƧИ⅃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- CODE MIRROR --> 
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.62.2/lib/codemirror.js" integrity="sha256-SuyBX0rELPHolKAbmGwtJ6Cb1Oi83AGWk8MCH6q2SEQ=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.62.2/lib/codemirror.css" integrity="sha256-0wqkEinay6WmMf1F6gVEv9sHx4mSggtnkAsQm1cJX7I=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.62.2/mode/javascript/javascript.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.62.2/mode/css/css.js" integrity="sha256-a3Yrc3Qc++OxgVCk4nAsT6B2IvrboLQvxbUiqpOXNkU=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.62.2/mode/xml/xml.js" integrity="sha256-0Yg9o24xI4hYyfU8U7GzhNFz9xmI/LTyK9H7a7GVWHY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.62.2/mode/htmlmixed/htmlmixed.js" integrity="sha256-km7gfgjhuaEXSSLiRlVpFdE5a4N0ESY9t/mxMg1rOIY=" crossorigin="anonymous"></script>


  <!-- -->
  <script src="localforage.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script src="b64.js"></script>
  <script src="https://lindseymysse.github.io/LNSYs-toolbox/helpers.js"></script>
  <script src="https://lindseymysse.github.io/qr-code-element/qr-code.js"></script>
  <script src="https://lindseymysse.github.io/peer-component/peer-component.js"></script>
  <style>

  body {
    font-family: monospace;
    color: white;
    background-color: black;
  }

    local-form, local-html {
      border:  1px solid white;
      display: block;
      box-sizing: content-box;
      padding:  1em;
    }

    local-form input {
      margin:  1em 0em 0em 0em;
    }

    local-variable {
      width:  100%;
      display: block;
    }

    local-file img{
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
    }

    local-variable input {
      width: calc(100% - 0.5em);
      padding: 0.25em;
    }
  </style>

  <script>

    /*

  LOCAL VARIABLE

  This is a little input component.  

*/


class LocalVariable extends HTMLElement {


  getValuesFromURL(URL = window.location.href ){
    const search_params = new URLSearchParams(URL)
    let options = {
    }
    for (const [key, unparsed_value] of search_params) {
      if(key !== window.location.origin + window.location.pathname + '?' ){
        try {
          const value = JSON.parse(decodeURI(unparsed_value))
          options[key] = value
        } catch {
          options[key] = decodeURI(unparsed_value)
        }
      }
    }
    return options
  }


  connectedCallback(){
    this.id = this.getAttribute('id')
    if(this.id === null){
      this.id = getNewID()
    }    
    
    this.name = this.getAttribute('name')
    if(this.name === null){
      this.name = this.id
    }

    this.source = this.getAttribute('source')
    if(this.source === null && this.querySelector('input') === null){
      this.initializeInput()
    } else {
      this.initializeOutput()
    }
  }

  initializeOutput(){
    const source = document.querySelector(`#${this.source}`)
    if(source !== null){
      this.innerText = source.value
      document.querySelector(`#${this.source}`)
        .addEventListener('UPDATED', (e) => {
          this.innerText = e.detail[this.source]
      })  
    } else {
      setTimeout(()=>this.initializeOutput(),1000)
    }
  }

  initializeInput(){


    const url_vars = this.getValuesFromURL()
    const local_var_value = localStorage.getItem(this.id)

    if(typeof(url_vars[this.id]) !== 'undefined'){
        this.value = url_vars[this.id]
    } else if(local_var_value !== null){
      this.value = local_var_value
    }  else {
      this.value = this.getAttribute('value')
      if(this.value === null){
        this.value = ''
      }
    }

    this.input = document.createElement('input')
    this.input.setAttribute('value', this.value)
    this.input.setAttribute('name', this.name)
    this.input.addEventListener('keydown', (e) => {
      if(e.key === "Enter" && !e.ctrlKey){
        this.setAttribute('value', e.target.value)
      }
    })
    
    this.input.addEventListener('blur', (e) => {
      this.setAttribute('value', e.target.value)
    })

    this.placeholder = this.getAttribute('placeholder')
    if(this.placeholder !== null){
      this.input.setAttribute('placeholder', this.placeholder)
    } else {
      this.input.setAttribute('placeholder', this.id)
    }
    this.appendChild(this.input)
    const create_event = new CustomEvent('CREATED', {id:this.id})
    this.dispatchEvent(create_event)
  }
  
  static get observedAttributes() {
    return ['value', 'id'];
  }

  update(new_value){
    this.value = new_value
    let detail = new Object()
    detail[this.id] = this.value
    localStorage.setItem(this.id, this.value)
    const new_event = new CustomEvent('UPDATED', {detail})
    this.dispatchEvent(new_event)
  }

  attributeChangedCallback(name, old_value, new_value){
    if(name === 'value' && old_value !== new_value){
      this.update(new_value)
    }

    if(name === 'id' && old_value !== new_value){
      const delete_event = new CustomEvent('DELETED', {id:this.id})
      this.dispatchEvent(delete_event)
    }
  }

  disconnectedCallback() {
    const delete_event = new CustomEvent('DELETED', {id:this.id})
    this.dispatchEvent(delete_event)
  }
}

/*
  this component can be placed in the document using the notation
  <custom-element title="element name here"></custom-element>
  to change the name of the element in the dom, change the 
  value in the quotation marks. 
*/

customElements.define('local-variable', LocalVariable)
    
    
  class LocalForm extends HTMLElement {
    connectedCallback(){

      const submit_button = document.createElement('input')
      submit_button.setAttribute('type', 'submit')
      submit_button.setAttribute('name', 'submit')
      setTimeout(() => {
        this.appendChild(submit_button)
      })
      submit_button.addEventListener('click', (e) => {
        e.preventDefault()
        let form_values = {}
        ;[...this.querySelectorAll('input')].forEach(input => {
          form_values[input.name] = input.value
        })

        delete form_values["submit"]
        const detail = form_values
        const new_event = new CustomEvent('UPDATED', {detail})
        this.dispatchEvent(new_event)
      })

      
    }
  
    static get observedAttributes() {
      return [];
    }
  
    attributeChangedCallback(name, old_value, new_value){
      switch(name){
        default:
      }
    }
  
  }
  
  customElements.define('local-form', LocalForm)
  


  
  
  
class LocalHTML extends HTMLElement {
  connectedCallback(){
    this.id = this.getAttribute('id')
    if(this.id === null){
      this.id = getNewID() 
    }
    localforage.getItem(this.id).then(content => {
      if(content === null){
        this.updateContent(content)
      } else {
        this.innerHTML = content
      }
    })
  }

  async updateContent(content = this.innerHTML){
    this.innerHTML = content
    ;await localforage.setItem(this.id, this.innerHTML)
    const detail = content
    const new_event = new CustomEvent('UPDATED', {detail})
    this.dispatchEvent(new_event)

  }


  static get observedAttributes() {
    return [];
  }

  attributeChangedCallback(name, old_value, new_value){
    switch(name){
      default:
    }
  }

}

customElements.define('local-html', LocalHTML)
  
  





class LocalFile extends HTMLElement {
  connectedCallback(){
    this.local_file = this.getAttribute('local-file-parts')
    if(this.local_file === null){
      this.innerHTML = `<error>LOCAL FILES REQUIRE A LIST OF ALL PARTS</error>`
    } else {

      this.load = this.getAttribute('load')
      if(this.load !== null && this.load){
        localforage.getItem(this.local_file).then(res => {
          const img = document.createElement('img')
          img.src = b64.decode(res)
          this.appendChild(img)
        })
      }
    }

  }

  static get observedAttributes() {
    return [];
  }

  attributeChangedCallback(name, old_value, new_value){
    switch(name){
      default:
    }
  }

}

customElements.define('local-file', LocalFile)



  
  
        

  </script>
</head>
<body>
  <details>
    <summary>
      Create New File
    </summary>

    <local-form id="local-file-settings">
      <local-variable id="local-file-key" placeholder="File Key" type="text"></local-variable>
      <local-variable id="local-file-summary" placeholder="Summary" type="text"></local-variable>
      <local-variable id="local-file-tags" placeholder="tags (comma separated)" type="text"></local-variable>
      <label>Keep Local
      <input type="checkbox" name="keep-local" id="keep-local" /> </label>
          <br />

      <input type="file" name="local-file" id="selected-local-file">
      <br />
    </local-form>
  </details>

  <details>
    <summary>File List</summary>
  <local-html id="local-file-list">
  </local-html>
</details>


<script type="text/javascript">


  document.querySelector('#local-file-settings').addEventListener('UPDATED', async (e) => {

    const reader = new FileReader()
    reader.addEventListener('load', async function(){

      let file_part_id = getNewID()
      await localforage.setItem(file_part_id, b64.encode(reader.result))
      file_data['local-file-parts'].push(file_part_id)

      const new_file = document.createElement('local-file')
      Object.keys(e.detail).forEach(key => {
        let value = e.detail[key]
        if(typeof value === 'array'){value = value.join(',')}
        new_file.setAttribute(key, value)
      })

      new_file.setAttribute('id', getNewID())
      

      new_file.setAttribute('load', true)
      const local_key = file_data['local-file-key']


      new_file.innerHTML = `

      <details>
        <summary> </summary>
        <button onclick="dispatch('DELETE', '${local_key}')">Delete</button>
      
        <local-variable id="${local_key}-file-key" 
          value="${file_data['local-file-key']}" 
          placeholder="file key" 
          name="local file key"
          type="text">
        </local-variable>

        <local-variable id="${local_key}-file-summary" 
          value="${file_data['local-file-summary']}"
          placeholder="Summary" 
          name="summary"
          type="text">
        </local-variable>
        <local-variable id="${local_key}-file-tags" 
          value="${file_data['local-file-tags']}"
          name="tags"
          placeholder="tags (comma separated)" 
          type="text">
        </local-variable>

      </details>

      <div>
        <h1 id="name">
          <local-variable source="${local_key}-file-key">
          </local-variable>
        </h1>
        <p>
      <local-variable source="${local_key}-file-summary">
      </local-variable> </p>
      <p>
      <local-variable source="${local_key}-file-tags"></local-variable></p>
      </div>

      `
      const local_file_list = document.querySelector('#local-file-list')
      local_file_list.appendChild(new_file)
      local_file_list.updateContent()

    })


    const file = document.querySelector('#selected-local-file').files[0]

    let file_data = e.detail

    file_data['local-file-parts'] = []


    if(file){
      reader.readAsDataURL(file)
    }
  })

  document.addEventListener('DELETE', (e) => {
    console.log(e)
    // document.querySelector(`[local-file-key="${e.detail}"]`).remove()
    // document.querySelector('#local-file-list').updateContent()
  })

</script>

</body>
</html>